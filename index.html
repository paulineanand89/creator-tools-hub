// -------- Main Checker --------
async function runChecker(){
  const htmlBox = document.getElementById("htmlInput");
  const urlBox = document.getElementById("urlInput");
  const out = document.getElementById("output");
  out.innerHTML = "<p>Checking...</p>";

  let html = htmlBox.value.trim();
  const url = urlBox.value.trim();

  if(!html && url){
    html = await fetchHtml(url);
    if(!html){
      out.innerHTML = "<p style='color:red'>Could not fetch this URL.</p>";
      return;
    }
  }
  if(!html || !url){
    out.innerHTML = "<p style='color:red'>Please paste HTML or enter a valid URL.</p>";
    return;
  }

  const checks = { trust:[], content:[], seo:[], technical:[], performance:[] };

  // Trust pages
  const policyResults = await checkPolicyPages(url);
  checks.trust.push({label:"Privacy Policy", ok: policyResults["Privacy Policy"]});
  checks.trust.push({label:"About Page", ok: policyResults["About Page"]});
  checks.trust.push({label:"Contact Page", ok: policyResults["Contact Page"]});
  checks.trust.push({label:"Terms / Disclaimer", ok: policyResults["Terms / Disclaimer"]});

  // robots.txt & sitemap
  const crawlResults = await checkRobotsAndSitemap(url);
  checks.technical.push({label:"robots.txt", ok: crawlResults.robots});
  checks.technical.push({label:"sitemap.xml", ok: crawlResults.sitemap});

  // Content
  const bodyText = html.replace(/<[^>]*>/g," ").trim();
  const wordCount = bodyText.split(/\s+/).length;
  checks.content.push({label:"Word Count â‰¥ 800", ok: wordCount>=800});
  checks.content.push({label:"Has Headers", ok: html.includes("<h1")||html.includes("<h2")});

  // SEO
  checks.seo.push({label:"Title Tag", ok: html.includes("<title>")});
  checks.seo.push({label:"Meta Description", ok: html.includes("name=\"description\"")});
  checks.seo.push({label:"Canonical Tag", ok: html.includes("rel=\"canonical\"")});

  // Technical (other)
  checks.technical.push({label:"HTTPS", ok: url.startsWith("https://")});
  checks.technical.push({label:"Viewport Meta", ok: html.includes("viewport")});
  checks.technical.push({label:"ads.txt", ok: html.includes("google.com")});

  // Performance placeholder
  checks.performance.push({label:"Basic Speed Check", ok: true});

  // Scoring
  let score = 0;
  let maxScore = 100;
  const weights = {trust:25, content:20, seo:20, technical:25, performance:10};

  for(const cat in checks){
    const passed = checks[cat].filter(c=>c.ok).length;
    const total = checks[cat].length;
    score += Math.round((passed/total)*weights[cat]);
  }

  if(!checks.trust[0].ok) maxScore = Math.min(maxScore,60);
  if(!checks.technical.find(c=>c.label==="HTTPS").ok) maxScore = Math.min(maxScore,50);
  if(!checks.content[0].ok) maxScore = Math.min(maxScore,55);
  if(score>maxScore) score=maxScore;

  let verdict="Low Risk";
  if(score<60) verdict="High Approval Risk";
  else if(score<80) verdict="Medium Risk";

  // Output
  out.innerHTML = "";
  for(const cat in checks){
    out.innerHTML += `<h3>${cat.toUpperCase()}</h3>`;
    checks[cat].forEach(c=>{
      out.innerHTML += `<div>${c.label}<span class="badge ${c.ok?"success":"error"}">${c.ok?"Pass":"Fail"}</span></div>`;
    });
    const catScore = Math.round((checks[cat].filter(c=>c.ok).length/checks[cat].length)*weights[cat]);
    out.innerHTML += `<div class="progress"><div class="bar ${cat}" style="width:${catScore}%"></div></div>`;
  }

  out.innerHTML += `<div class="score">Final Score: ${score}/100</div>`;
  out.innerHTML += `<div class="verdict">${verdict}</div>`;
  out.innerHTML += `<button onclick="window.print()">Download Free Report (PDF)</button>`;
}
